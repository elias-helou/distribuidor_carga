<!DOCTYPE html>
<meta charset="UTF-8">
<head>
    <title>Distribuidor de Carga Didática</title>
    <style>
        /* Estilos pertinentes à visão de planilha começam com shvw_ */
        .shvw_sheet {
            margin: 0;
            padding: 0;
            border-style: none;
            border-width: 0;
            display: flex;
        }
        .shvw_corner {
            margin: 0;
            padding: 0.1em;
            background-color: white;
            border-color: black;
            border-style: solid;
            border-width: 1px;
            font-size: 1em;
            font-weight: bold;
            width: 10em;
            min-width: 10em;
            height: 1.4em;
            position: fixed;
            left: auto;
            top: auto;
        }
    </style>
    <script>
        // Variáveis globais

        // Aparência:
        var cor_cabecalho_inativo = "rgb(255, 220, 200)";
        var cor_cabecalho_ativo = "rgb(252, 164, 74)";
        var cor_aba_ativa = "rgb(150, 150, 200)";
        var cor_aba_inativa = "rgb(190, 190, 240)";
        var cor_celula_ativa = "rgb(0, 0, 0)";
        var cor_celula_inativa = "rgb(200, 200, 200)";
        var cor_travado = "rgba( 0, 0, 0, 0.2 )";
        var rh_width = "11em";
        var rh_height = "1.6em";
        var ch_width = "9em";
        var ch_height = "5.3em";
        var h_fontsize = "1.0em";

        // Dados:
        var disciplinas = {};
        var docentes = [];
        var formularios = {};
        var saldos = {};
        var popularidade = {};
        var atribuicao =  {};
        var trava = {};
        var exclui = {};
        var log = [];
        var cargas = {};

        ////////////////////////////////////////////////////////////

        function make_c_header( text ) {
            var retval = document.createElement( "div" );
            retval.style.backgroundColor = cor_cabecalho_inativo;
            retval.style.margin = "0";
            retval.style.padding = "0.1em";
            retval.style.borderStyle = "solid";
            retval.style.borderWidth = "1px";
            retval.style.borderRadius = "1px";
            retval.style.fontSize = h_fontsize;
            retval.style.width = ch_width;
            retval.style.minWidth = ch_width;
            retval.style.maxWidth = ch_width;
            retval.style.height = ch_height;
            retval.style.userSelect = "none";
            retval.style.position = "relative";
            retval.style.fontWeight = "bold";
            retval.id = "ch_" + text;
            retval.disciplina = text;
            retval.addEventListener( "click", trava_disc );

            var cursos = disciplinas[ text ][ "cursos" ]
            cursos = cursos.replace( "Cursos:<br>", "" );
            cursos = cursos.replace( "Curso:<br>", "" );
            cursos = cursos.replaceAll( "<br>", "," );
            cursos = cursos.replaceAll( "&emsp;", " " );

            var dn = document.createElement( "div" );
            dn.style.display = "block";
            dn.style.textOverflow = "ellipsis";
            dn.style.whiteSpace = "nowrap";
            dn.style.maxWidth = ch_width;
            dn.style.minWidth = "100%";
            dn.style.overflow = "hidden";
            dn.style.fontSize = "small";
            dn.innerHTML = cursos;
            retval.appendChild( dn );

            var dc = document.createElement( "div" );
            dc.style.marginTop = "0.2em";
            dc.style.paddingBottom = "0.3em";
            dc.style.textAlign  = "left";
            dc.style.marginRight = "1em";
            dc.style.flexGrow = "0";
            dc.style.textOverflow = "ellipsis";
            dc.style.whiteSpace = "nowrap";
            dc.style.overflow = "hidden";
            dc.style.maxWidth = "100%";

            dc.innerHTML = text.slice( 0, 7 ) + "  <small>" + disciplinas[ text ][ 'nome' ] + "</small>";
            retval.appendChild( dc );

            var dcur = document.createElement( "div" );
            dcur.style.display = "block";
            dcur.style.whiteSpace = "nowrap";
            dcur.style.maxWidth = "100%";
            dcur.style.overflow = "hidden";
            dcur.style.fontFamily = "monospace";
            dcur.style.fontSize = "small";
            dcur.innerHTML = disciplinas[ text ][ 'horario' ];
            retval.appendChild( dcur );

            return retval;
        }

        function make_r_header( text ) {
            var retval = document.createElement( "div" );
            retval.style.backgroundColor = cor_cabecalho_inativo;
            retval.style.margin = "0";
            retval.style.padding = "0.1em";
            retval.style.borderStyle = "solid";
            retval.style.borderWidth = "1px";
            retval.style.borderRadius = "1px";
            retval.style.fontSize = h_fontsize;
            retval.style.fontWeight = "bold";
            retval.style.width = rh_width;
            retval.style.minWidth = rh_width;
            retval.style.height = rh_height;
            retval.style.textAlign = "left";
            retval.style.alignContent = "center";
            retval.style.overflow = "hidden";
            retval.style.whiteSpace = "nowrap";
            retval.style.textOverflow = "ellipsis";
            retval.style.userSelect = "none";
            retval.style.position = "relative";
            retval.docente = text;
            retval.innerHTML = text;
            retval.id = "rh_" + text;
            retval.addEventListener( "click", trava_doc );

            return retval;
        }

        function handle_scroll_rhc( e ) {
            var w = document.getElementById( "window" );

            var rhc = document.getElementById( "shvw_r_header_container" );
            rhc.scroll( { top: w.scrollTop, left: 0, behavior: "instant" } );

            var chc = document.getElementById( "shvw_c_header_container" );
            chc.scroll( { top: 0, left: w.scrollLeft, behavior: "instant" } );
        }

        // Clique na célula:
        function clique_celula( e ) {
            if ( e.ctrlKey ) {
                trava_doc_disc( e );
                return;
            }

            var t = e.target;
            // Qual disciplina e qual docente da célula?
            const disc = t.disciplina;
            const doc = t.docente;

            // Se o docente está atribuído, remove
            if ( atribuicao[ disc ].includes( doc ) ) {
                const idx = atribuicao[ disc ].indexOf( doc );
                atribuicao[ disc ].splice( idx, 1 );
            }
            // Caso contrário inclui o docente e ordena a lista
            // de atribuídos
            else {
                atribuicao[ disc ].push( doc );
                atribuicao[ disc ].sort();
            }

            alterna_celula_atribuicao( disc, doc );
            console.log( otm_vizinhanca( atribuicao, [] ) );
        }

        // Esta função alterna o destaque em vermelho da célula
        // quando esta está ou não atribuída.
        // Esta função não altera a atribuição, somente liga ou
        // desliga o destaque em vermelho de acordo com a atribuição
        // atual
        function alterna_celula_atribuicao( disc, doc ) {
            var cell = document.getElementById( "cel_" + disc + "_" + doc );
            if ( !cell ) {
                return;
            }

            // Remove destaque, se houver:
            var o = document.getElementById( "o_cel_" + disc + "_" + doc );
            if ( o ) {
                o.remove();
            }

            // Caso esteja atribuída, cria o destaque em vermelho:
            if ( atribuicao[ disc ].includes( doc ) ) {
                var o = document.createElement( "div" );
                o.style.margin = "0";
                o.style.backgroundColor = "red";
                o.style.opacity = "0.5";
                o.style.minWidth = "100%";
                o.style.minHeight = "100%";
                cell.insertAdjacentElement( 'afterbegin', o );
                o.style.position = "absolute";
                o.style.left = "0";
                o.style.top = "0";
                o.disciplina = cell.disciplina;
                o.docente = cell.docente;
                o.id = "o_" + cell.id;
                o.iscell = true;
            }
        }

        function ilumina_cabecalho( e ) {
            const t = e.target;
            const rt = e.relatedTarget;

            if ( rt && rt.iscell ) {
                document.getElementById( "ch_" + rt.disciplina ).style.backgroundColor = cor_cabecalho_inativo;
                document.getElementById( "rh_" + rt.docente ).style.backgroundColor = cor_cabecalho_inativo;
            }

            document.getElementById( "ch_" + t.disciplina ).style.backgroundColor = cor_cabecalho_ativo;
            document.getElementById( "rh_" + t.docente ).style.backgroundColor = cor_cabecalho_ativo;
        }

        function apaga_cabecalho( e ) {
            const t = e.target;
            const rt = e.relatedTarget;

            if ( rt && rt.iscell ) {
                return;
            }

            document.getElementById( "ch_" + t.disciplina ).style.backgroundColor = cor_cabecalho_inativo;
            document.getElementById( "rh_" + t.docente ).style.backgroundColor = cor_cabecalho_inativo;
        }

        function cria_play_btn() {
            var play_btn = document.createElement( "button" );

            play_btn.style.width = "50%";
            play_btn.style.minHeight = "50%";
            
            var play_icon = document.createElementNS( "http://www.w3.org/2000/svg", "svg" );
            play_icon.innerHTML = `
                <path d="M-4 -4 L5 0 L-4 4 Z" style="fill:gray;stroke:black;stroke-width:0.5;" stroke-linejoin="round" />
            `;
            play_icon.setAttribute( "viewBox", "-15 -5 30 10" );
            play_btn.appendChild( play_icon );

            return play_btn;
        }

        function cria_next_btn() {
            var retval = document.createElement( "button" );

            retval.style.width = "50%";
            retval.style.minHeight = "50%";
            
            var icon = document.createElementNS( "http://www.w3.org/2000/svg", "svg" );
            icon.innerHTML = `
                <path d="M0 -4 L9 0 L0 4 Z" style="fill:gray;stroke:black;stroke-width:0.5;" 
                stroke-linejoin="round" />
                <path d="M10 -4 L13 -4 L13 4 L10 4 Z" style="fill:gray;stroke:black;stroke-width:0.5;" stroke-linejoin="round" />
            `;
            icon.setAttribute( "viewBox", "-8.5 -5 30 10" );
            retval.appendChild( icon );

            return retval;
        }

        function cria_undo_btn() {
                var retval = document.createElement( "button" );

            retval.style.width = "50%";
            retval.style.minHeight = "50%";
            
            var icon = document.createElementNS( "http://www.w3.org/2000/svg", "svg" );
            icon.innerHTML = `
                <path d="M5.5 0 A5.5 5.5 0 1 0 -5.5 0 L-7.5 0 L-3.5 2.5 L-0.5 0 L-2.5 0 A2.5 2.5 0 1 1 2.5 0 Z" style="fill:gray;stroke:black;stroke-width:0.5;" 
                stroke-linejoin="round" />
            `;
            icon.setAttribute( "viewBox", "-15 -7 30 10" );
            retval.appendChild( icon );

            return retval;
        }

        function cria_pause_btn() {
            var pause_btn = document.createElement( "button" );

            pause_btn.style.width = "50%";
            pause_btn.style.minHeight = "50%";
            
            var pause_icon = document.createElementNS( "http://www.w3.org/2000/svg", "svg" );
            pause_icon.innerHTML = `
                <path d="M-4 -4 L-1 -4 L-1 4 L-4 4 Z" style="fill:gray;stroke:black;stroke-width:0.5;" stroke-linejoin="round" />
                <path d="M1 -4 L4 -4 L4 4 L1 4 Z" style="fill:gray;stroke:black;stroke-width:0.5;" stroke-linejoin="round" />
            `;
            pause_icon.setAttribute( "viewBox", "-15 -5 30 10" );
            pause_btn.appendChild( pause_icon );

            return pause_btn;
        }

        function cria_tabela( parent ) {
            const n_columns = Object.keys( disciplinas ).length;
            const n_rows = docentes.length;

            if ( ! ( n_columns * n_rows ) ) {
                return;
            }

            var planilha = document.createElement( "div" );
            planilha.style.overflow = "scroll";
            planilha.style.padding = "0";
            planilha.style.margin = "0";
            planilha.style.borderWidth = "0";
            planilha.style.maxHeight =  "calc( 98vh - 5em )";
            parent.appendChild( planilha );

            var sheet = document.createElement( "div" );
            sheet.id = "shvw_sheet";
            sheet.style.backgroundColor = "white";
            sheet.style.display = "grid";
            sheet.style.width = "fit-content";
            sheet.style.height = "fit-content";
            planilha.appendChild( sheet );

            var cells_container = document.createElement( "div" );
            cells_container.style.padding = "0";
            cells_container.style.margin = "0";
            cells_container.style.borderWidth = "0";
            cells_container.style.gridRow = "2";
            cells_container.style.gridColumn = "2";
            cells_container.style.display = "flex";
            sheet.appendChild( cells_container );

            var mx_p = 0;
            for ( var doc in formularios ) {
                for ( var di in formularios[ doc ] ) {
                    var p = formularios[ doc ][ di ][ 'prioridade' ];
                    if ( mx_p < p ){
                        mx_p = p;
                    }
                }
            }

            var d_list = Object.keys( disciplinas );

            for ( var j = 0; j < n_columns; j++ ) {
                var frhc = document.createElement( "div" );
                cells_container.appendChild( frhc );

                var d = d_list[ j ];

                for ( var i = 0; i < n_rows; ++i ) {

                    var cell = document.createElement( "div" );
                    cell.style.textAlign = "left";
                    cell.style.display = "flex";
                    cell.style.minHeight = rh_height;
                    cell.style.maxHeight = rh_height;
                    cell.style.minWidth = ch_width;
                    cell.style.borderWidth = "1px";
                    cell.style.borderStyle = "solid";
                    cell.style.padding = "0.1em";
                    cell.style.fontWeight = "bold";
                    cell.style.position = "relative";
                    cell.style.borderColor = cor_celula_inativa;
                    cell.style.fontSize = h_fontsize;
                    cell.addEventListener( "click", clique_celula );
                    cell.disciplina = d;
                    cell.docente = docentes[ i ];
                    cell.id = "cel_" + d + "_" + docentes[ i ];
                    cell.iscell = true;
                    cell.addEventListener( "mouseover", ilumina_cabecalho );
                    cell.addEventListener( "mouseleave", apaga_cabecalho );
                    frhc.appendChild( cell );

                    if ( formularios[ docentes[ i ] ][ d ] ) {
                        var p = formularios[ docentes[ i ] ][ d ][ 'prioridade' ];
                        cell.innerHTML = p.toString();

                        var r = 80;
                        var g = 180;
                        var b = 170;

                        var alpha = ( mx_p + 1 - p ) / mx_p;
                        r = r * alpha + 255 * ( 1 - alpha );
                        g = g * alpha + 255 * ( 1 - alpha );
                        b = b * alpha + 255 * ( 1 - alpha );

                        cell.style.backgroundColor = "rgb( " + r + ", " + g + ", " + b + " )";
                    }
                    else {
                        cell.style.backgroundColor = "white";
                    }

                    alterna_celula_atribuicao( d, docentes[ i ] );
                }
            }

            var rhc = document.createElement( "div" );
            rhc.id = "shvw_r_header_container";
            rhc.style.gridRow = "2";
            rhc.style.gridColumn = "1";
            rhc.style.height = "inherit";
            rhc.style.overflow = "hidden";
            rhc.style.position = "sticky";
            rhc.style.left = "0";
            rhc.style.width = "max-content";
            rhc.style.backgroundColor = cor_cabecalho_inativo;
            sheet.appendChild( rhc );

            var chc = document.createElement( "div" );
            chc.style.display = "flex";
            chc.id = "shvw_c_header_container";
            chc.style.gridRow = "1";
            chc.style.gridColumn = "2";
            chc.style.width = "inherit";
            chc.style.overflow = "hidden";
            chc.style.position = "sticky";
            chc.style.top = "0";
            sheet.appendChild( chc );

            for ( var i = 0; i < n_rows; i++ ) {
                rhc.appendChild( make_r_header( docentes[ i ] ) );
                alterna_trava_doc( i );
            }

            for ( var d in disciplinas ) {
                chc.appendChild( make_c_header( d ) );
                alterna_trava_disc( d );
            }

            var corner = document.createElement( "div" );
            corner.className = "shvw_corner";
            corner.style.fontSize = h_fontsize;
            corner.style.minHeight = ch_height;
            corner.style.height = ch_height;
            corner.style.minWidth = rh_width;
            sheet.appendChild( corner );

            var play_btn = cria_play_btn();
            play_btn.addEventListener(
                "click",
                () => { 
                    parar_loop = false;
                    alert_new();
                    loop_tabu();
                }
            )
            corner.appendChild( play_btn );
            var next_btn = cria_next_btn();
            next_btn.addEventListener( "click", loop_tabu );
            corner.appendChild( next_btn );
            var pause_btn = cria_pause_btn();
            corner.appendChild( pause_btn );
            var undo_btn = cria_undo_btn();
            corner.appendChild( undo_btn );
        }

        var abas = [ "E/S", "Planilha", "Formulários", "Agendas", "Otimização", "Análise" ];
        var aba_ativa = abas[ 0 ];
        
        function cria_abas() {
            var body = document.getElementById( "body" );
            body.style.paddingTop = "1vh";
            body.style.paddingBottom = "1vh";
            body.style.paddingLeft = "1vw";
            body.style.paddingRight = "1vw";
            body.style.border = "none";
            body.style.borderWidth = "0";
            body.style.backgroundColor = "rgb(250, 250, 250)";
            body.style.alignItems = "center";
            body.style.margin = "0";
            body.style.overflow = "hidden";

            var w = document.getElementById( "window" );
            w.style.overflow = "hidden";

            var main_el = document.createElement( "div" );
            main_el.style.maxHeight = "98vh";
            main_el.style.maxWidth = "98vw";
            body.appendChild( main_el );

            var abas_container = document.createElement( "div" );
            abas_container.style.display = "flex";
            main_el.appendChild( abas_container );
            for ( var i in abas ) {
                var aba = document.createElement( "div" );
                if ( abas[ i ] == aba_ativa ){
                    aba.style.backgroundColor = cor_aba_ativa;
                }
                else {
                    aba.style.backgroundColor = cor_aba_inativa;
                }
                aba.style.borderRadius = "5px 5px 0 0";
                aba.style.borderTopStyle = "solid";
                aba.style.borderLeftStyle = "solid";
                aba.style.borderRightStyle = "solid";
                aba.style.borderBottomStyle = "none";
                aba.style.borderWidth = "1px";
                aba.style.padding = "0.5em";
                aba.style.fontSize = "1.25em";
                aba.style.margin = "1px";
                aba.style.marginBottom = "0";
                aba.innerHTML = abas[ i ];
                aba.id = abas[ i ];
                aba.addEventListener( "click", ativa_aba );
                aba.style.userSelect = "none";

                abas_container.appendChild( aba );
            }

            var inter = document.createElement( "div" );
            inter.style.backgroundColor = cor_aba_ativa;
            inter.style.padding = "10px";
            inter.style.border = 'solid';
            inter.style.borderWidth = "1px";
            inter.id = "inter";
            main_el.appendChild( inter );

            atua_aba();
        }

        function carrega() {
            var arqinput = document.getElementById( "arqinput" );

            var fr = new FileReader();
            fr.onload = function (){
                var text = fr.result;

                var tmp = JSON.parse( text );
                disciplinas = tmp[ 'disciplinas' ];
                docentes = tmp[ 'docentes' ];
                formularios = tmp[ 'formularios' ];
                saldos = tmp[ 'saldos' ];

                var a = tmp[ 'atribuicao' ];
                if ( a ) {
                    atribuicao = a;
                }
                else{
                    for ( var d in disciplinas ) {
                        atribuicao[ d ] = [];
                    }
                }
            
                var t = tmp[ 'trava' ];
                if ( t ) {
                    trava = t;
                }
                else{
                    for ( var d in disciplinas ) {
                        trava[ d ] = false;
                    }
                    for ( var i in docentes ) {
                        trava[ docentes[ i ] ] = false;
                    }
                    for ( var d in disciplinas ) {
                        for ( var i in docentes ) {
                            trava[ docentes[ i ] + d ] = false;
                        }
                    }
                }

                var c = tmp[ "cargas" ];
                if( c ) {
                    cargas = c;
                }
                else {
                    for ( d in disciplinas ) {
                        cargas[ d ] = 1.0;
                    }
                }

                // atualiza_seletores();
                // cria_escolhedores();

                for ( var d in disciplinas ) {
                    var pop = 0.0;
                    for ( var doc in disciplinas[ d ][ 'escolhedores' ] ) {
                        pop += 1.0 / formularios[ disciplinas[ d ][ 'escolhedores' ][ doc ][ 1 ] ][ d ][ 'prioridade' ];
                    }
                    popularidade[ d ] = pop;
                }

                // atualiza_lista_disciplinas();
                console.log( atribuicao );
                console.log( otm_verifica_conflitos( atribuicao ) );
            };
            fr.readAsText( arqinput.files[ 0 ] );
        }

        function cria_es() {
            var arqinput = document.createElement( "input" );
            arqinput.type = "file";
            arqinput.id = "arqinput";

            var inter = document.getElementById( "inter" );
            inter.appendChild( arqinput );
            
            var b = document.createElement( "button" );
            b.innerHTML = "Carregar arquivo";
            b.addEventListener( "click", carrega );
            inter.appendChild( b );
        }

        function ativa_aba( e ) {
            var t = e.target;
            var a = document.getElementById( aba_ativa );

            a.style.backgroundColor = cor_aba_inativa;
            t.style.backgroundColor = cor_aba_ativa;

            aba_ativa = t.id;

            atua_aba();
        }
    function atua_aba() {
        var inter = document.getElementById( "inter" );
        inter.innerHTML = "";
        switch ( aba_ativa ) {
            case abas[ 0 ]:
                cria_es();
                break;
            case abas[ 1 ]:
                cria_tabela( inter );
                break;
            case abas[ 2 ]:
                break;
            case abas[ 3 ]:
                break;
        }
    }

    function alterna_trava_disc( disc ) {
        for ( var i in docentes ) {
            var c = document.getElementById( "cel_" + disc + "_" + docentes[ i ] );
            var t = document.getElementById( "t_cel_" + disc + "_" + docentes[ i ] );

            if ( t ) {
                t.remove();
            }

            if ( trava[ disc ] || trava[ docentes[ i ] ] || trava[ docentes[ i ] + disc ] ) {
                var t = document.createElement( "div" );
                t.style.margin = "0";
                t.style.height = "100%";
                t.style.width = "100%";
                t.style.backgroundColor = "rgba( 0, 0, 0, 0.2 )";
                c.appendChild( t );
                t.style.position = "absolute";
                t.style.left = "0";
                t.style.top = "0";
                t.iscell = true;
                t.docente = c.docente;
                t.disciplina = c.disciplina;
                t.id = "t_cel_" + disc + "_" + docentes[ i ];
            }
        }
        var c = document.getElementById( "ch_" + disc );
        var t = document.getElementById( "t_ch_" + disc );

        if ( t ) {
            t.remove();
        }

        if ( trava[ disc ] ) {
            var t = document.createElement( "div" );
            t.style.margin = "0";
            t.style.height = "100%";
            t.style.width = "100%";
            t.style.backgroundColor = cor_travado;
            c.appendChild( t );
            t.style.position = "absolute";
            t.style.left = "0";
            t.style.top = "0";
            t.docente = c.docente;
            t.disciplina = c.disciplina;
            t.id = "t_ch_" + disc;
        }
    }

    function trava_disc( e ) {
        if ( !e.ctrlKey ) {
            return;
        }
        var t = e.target;
        while ( !t.disciplina ) {
            t = t.parentElement;
        }

        trava[ t.disciplina ] = !trava[ t.disciplina ];
        alterna_trava_disc( t.disciplina );
    }

    function trava_doc( e ) {
        if ( !e.ctrlKey ) {
            return;
        }
        var t = e.target;
        while ( !t.docente ) {
            t = t.parentElement;
        }

        trava[ t.docente ] = !trava[ t.docente ];
        alterna_trava_doc( docentes.indexOf( t.docente ) );
    }

    function alterna_trava_doc( i ) {
        for ( var disc in disciplinas ) {
            var c = document.getElementById( "cel_" + disc + "_" + docentes[ i ] );
            var t = document.getElementById( "t_cel_" + disc + "_" + docentes[ i ] );

            if ( t ) {
                t.remove();
            }

            if ( trava[ docentes[ i ] ] || trava[ disc ] || trava[ docentes[ i ] + disc ] ) {
                var t = document.createElement( "div" );
                t.style.margin = "0";
                t.style.height = "100%";
                t.style.width = "100%";
                t.style.backgroundColor = "rgba( 0, 0, 0, 0.2 )";
                c.appendChild( t );
                t.style.position = "absolute";
                t.style.left = "0";
                t.style.top = "0";
                t.iscell = true;
                t.docente = c.docente;
                t.disciplina = c.disciplina;
                t.id = "t_cel_" + disc + "_" + docentes[ i ];
            }
        }
        var c = document.getElementById( "rh_" + docentes[ i ] );
        var t = document.getElementById( "t_rh_" + docentes[ i ] );

        if ( t ) {
            t.remove();
        }

        if ( trava[ docentes[ i ] ] ) {
            var t = document.createElement( "div" );
            t.style.margin = "0";
            t.style.height = "100%";
            t.style.width = "100%";
            t.style.backgroundColor = cor_travado;
            c.appendChild( t );
            t.style.position = "absolute";
            t.style.left = "0";
            t.style.top = "0";
            t.docente = c.docente;
            t.disciplina = c.disciplina;
            t.id = "t_rh_" + docentes[ i ];
        }
    }

    function trava_doc_disc( e ) {
        var t = e.target;

        // Qual disciplina e qual docente da célula?
        const disc = t.disciplina;
        const doc = t.docente;

        trava[ doc + disc ] = !trava[ doc + disc ];
        alterna_trava_doc_disc( doc, disc );
    }

    function alterna_trava_doc_disc( doc, disc ) {
        var c = document.getElementById( "cel_" + disc + "_" + doc );
        var t = document.getElementById( "t_cel_" + disc + "_" + doc );

        if ( t ) {
            t.remove();
        }

        if ( trava[ disc ] || trava[ doc ] || trava[ doc + disc ] ) {
            var t = document.createElement( "div" );
            t.style.margin = "0";
            t.style.height = "100%";
            t.style.width = "100%";
            t.style.backgroundColor = "rgba( 0, 0, 0, 0.2 )";
            c.appendChild( t );
            t.style.position = "absolute";
            t.style.left = "0";
            t.style.top = "0";
            t.iscell = true;
            t.docente = c.docente;
            t.disciplina = c.disciplina;
            t.id = "t_cel_" + disc + "_" + doc;
        }
    }

    function cria_otimizador( texto_aba ) {

        var optc = document.createElement( "div" );

    }

    // Otimização e busca

    // Calcula, a partir da atribuição descrita por
    // disciplinas, a mesma atribuição, mas agora
    // descrita por docente.
    function otm_disc2doc( atrib ) {
        retval = {}
        for ( i in docentes ) {
            retval[ docentes[ i ] ] = [];
        }

        for ( disc in disciplinas ) {
            for ( i in atrib[ disc ] ) {
                retval[ atrib[ disc ][ i ] ].push( [ disc, atrib[ disc ].length ] );
            }
        }

        return retval;
    }

    // Constantes de avaliação:
    var K_natrib      = 1.0e6;    // Penalização por disciplina sem atribuição
    var k_conflito    = 1.0e7;    // Penalização por conflito de horário
    var k_disc_gemeas = 1.0;      // Bônus por atribuição de disciplinas gêmeas
    var k_nesc        = 1.0e5;    // Penalização por atribuição de não escolhida
    var k_score_disc  = 1.0e2;    // Penalização por docente com menos score ter menos disciplinas
    var k_score_escs  = 1.0e1;    // Penalização por docente com menos score ter mais prioridades

    // Calcula score de prioridades atribuídas do docente
    // TODO: esta função pode ser aprimorada se utilizarmos
    // a atribuição descrita por docente.
    function otm_score_escolhas_doc( doc, atrib ){
        var retval = 0.0;

        for ( var disc in disciplinas ) {
            // Não avalia disciplinas travadas
            if ( ! ( trava[ disc ] || exclui[ disc ] ) ) {
                // Caso tenha sido escolhida, soma valor
                // da penalidade por prioridade
                if ( atrib[ disc ].includes( doc ) ){
                    var p = formularios[ doc ][ disc ]
                    if ( p ) {
                        p = formularios[ doc ][ disc ][ 'prioridade' ];
                        retval = retval + 2 ** p;
                    }
                    // Caso não tenha sido escolhida, soma
                    // penalidade por não ter sido escolhida
                    else {
                        retval = retval + k_nesc;
                    }
                }
            }
        }

        return retval;
    }

    // Soma todos scores de prioridades
    function otm_score_escolhas( atrib ) {
        var retval = 0.0;

        for ( var i in docentes ) {
            retval = retval + otm_score_escolhas_doc( docentes[ i ], atrib );
        }

        return retval;
    }

    // Transforma o horário de cada aula em um
    // trio de strings: dia da semana, hora de início
    // e hora de fim
    function otm_horario2triplet( disc ) {
        var htexto = disciplinas[ disc ][ "horario" ];
        htexto = htexto.replace( "Horário:<br>&emsp;", "" );

        retval = [];

        // Sem horário retorna lista vazia
        if ( htexto == "A definir" ) {
            return retval;
        }

        // Primeira aula
        retval.push( [ htexto.slice( 0, 3 ), htexto.slice( 5, 10 ), htexto.slice( 11, 16 ) ] );
        if ( htexto.length == 16 ) {
            return retval;
        }

        // Segunda aula
        htexto = htexto.slice( 26 );
        retval.push( [ htexto.slice( 0, 3 ), htexto.slice( 5, 10 ), htexto.slice( 11, 16 ) ] );

        // Generalizar para se houver mais de duas aulas semanais!

        return retval;
    }

    // Transforma horário em par de minutos passados desde as
    // 00:00 de segunda (começo e fim de cada aula)
    function otm_horario2minutos( disc ) {
        var retval = otm_horario2triplet( disc );

        dias = [ "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb", "Dom" ];
        for ( var i in retval ) {
            var tmp = 24 * 60 * dias.indexOf( retval[ i ][ 0 ] );
            retval[ i ] = [
                tmp + 60 * parseInt( retval[ i ][ 1 ].slice( 0, 2 ) ) + parseInt( retval[ i ][ 1 ].slice( 3 ) ),
                tmp + 60 * parseInt( retval[ i ][ 2 ].slice( 0, 2 ) ) + parseInt( retval[ i ][ 2 ].slice( 3 ) )
            ];
        }

        return retval;
    }

    // Verifica disciplinas com horários conflitantes
    // atribuídas a um docente.
    // TODO: esta disciplina fica mais eficiente
    // se a atribuição for descrita por docente
    function otm_verifica_conflito( doc, atrib ) {
        var minutos = [];

        // Aqui é possível melhorar fazendo por docente!
        for ( var disc in disciplinas ) {
            if ( atrib[ disc ].includes( doc ) ) {
                minutos.push( otm_horario2minutos( disc ) );
            }
        }
        
        retval = 0.0;

        for ( var i = 0; i < minutos.length; i++ ) {
            for ( var j = i + 1; j < minutos.length; j++ ) {
                for ( var k in minutos[ i ] ) {
                    for ( var l in minutos[ j ] ) {
                        if (
                            (
                                ( minutos[ i ][ k ][ 0 ] <= minutos[ j ][ l ][ 1 ] ) &&
                                ( minutos[ i ][ k ][ 1 ] >= minutos[ j ][ l ][ 0 ] )
                            )
                        ) {
                            retval = retval + 1.0;
                        }
                    }
                }
            }
        }

        return retval;
    }
    // TODO: calcular aqui a atribuição descrita por docente e passar ela
    // para a função otm_verifica_conflito
    function otm_verifica_conflitos( atrib ) {
        var retval = 0.0;
        for ( var i in docentes ) {
            retval = retval + otm_verifica_conflito( docentes[ i ], atrib );
        }
        return retval;
    }

    // Checa igualdade entre uas atribuições.
    function otm_atrib_iguais ( atribA, atribB ) {
        for ( var dis in disciplinas ) {
            if ( !atribA[ dis ].every( ( val, index ) => val === atribB[ dis ][ index ] ) ) {
                return false;
            }
        }

        return true;
    }

    // Verifica se alguma atribuição está no tabu
    function otm_tabu_contem( atrib, tabu ) {
        return tabu.some( ( val, index ) => otm_atrib_iguais( atrib, val ) );
    }

    // Esta função calcula a vizinhança de uma atribuição
    // levando o tabu em consideração (as atribuições que
    // estão no tabu são ignoradas).
    function otm_vizinhanca( atrib, tabu ) {
        var viz = [];

        var dis_arr = Object.keys( disciplinas ); 

        // Percorre todas as disciplinas
        for ( var i = 0; i < dis_arr.length; i++ ) {
            var dis = dis_arr[ i ];

            // Caso a disciplina esteja travada ou excluída,
            // não a consideramos na vizinhança
            if ( trava[ dis ] || exclui[ dis ] ) {
                continue;
            }

            // Percorre todos os docentes
            for ( var id in docentes ) {
                var doc = docentes[ id ];

                // Caso o docente esteja travado ou excluído,
                // não o consideramos na vizinhança. Também
                // não consideramos docentes que não escolheram
                // a disciplina atual.
                if (
                    trava[ doc ] ||
                    trava[ doc + dis ] ||
                    exclui[ doc ] ||
                    !formularios[ doc ][ dis ]
                ) {
                    continue;
                }

                // A vizinha é quase idêntica à atribuição atual
                var v = {...atrib};

                // Exceto pela disciplina atual, que será atribuída
                // ao docente atual
                v[ dis ] = [ doc ];
                if ( !otm_tabu_contem( v, tabu ) ){
                    viz.push( v );
                }
            }

            // Remover o docente atualmente atribuído à
            // disciplina também é uma possibilidade de
            // atribuição vizinha
            if ( atrib[ dis ].length > 0 ) {
                var v = {...atrib};
                v[ dis ] = [];
                if ( !otm_tabu_contem( v, tabu ) ){
                    viz.push( v );
                }
            }

            // Percorre todas as disciplinas
            for ( var j = i + 1; j < dis_arr.length; j++ ) {
                var disb = dis_arr[ j ];

                // Caso seja possível trocar as atribuições de
                // dis e disb sem violar as escolhas nos formulários,
                // essa troca também gera um vizinho
                if(
                    (
                        ( atrib[ dis ].length == 0 ) ||
                        ( formularios[ atrib[ dis ][ 0 ] ][ disb ] )
                        // Generalizar para o caso de haver
                        // mais de um docente na atribuição
                    ) &&
                    (
                        ( atrib[ disb ].length == 0 ) ||
                        ( formularios[ atrib[ disb ][ 0 ] ][ dis ] )
                        // Generalizar para o caso de haver
                        // mais de um docente na atribuição
                    )
                ) {
                        // Se dis e disb são iguais, não faz sentido trocar
                        // e este caso não gera um vizinho
                        if ( atrib[ dis ].length + atrib[ disb.length ] == 0 ) {
                            continue;
                        }
                        if (
                            ( atrib[ dis ].length === atrib[ disb ].length ) &&
                            atrib[ dis ].every( ( val, index ) => val === atrib[ disb ][ index ] )
                        ) {
                            continue;
                        }

                        // Efetua a troca e inclui na vizinhança
                        var v = {...atrib};
                        v[ dis ] = atrib[ disb ];
                        v[ disb ] = atrib[ dis ];
                        if ( !otm_tabu_contem( v, tabu ) ){
                            viz.push( v );
                        }
                }
            }
        }

        return viz;
    }

    function ana_verifica_conflitos( atrib ) {
        var retval = [];
        for ( var i in docentes ) {
            if( otm_verifica_conflito( docentes[ i ], atrib ) > 0 ) {
                retval.push( docentes[ i ] );
            }
        }
        return retval;
    }

    var parar_loop = true;
    var niter = 0;

    function loop_tabu() {

        // Executa um passo da busca

        console.log( "Rodando!" );
        console.time( "loop_tabu" )

        var viz = otm_vizinhanca( atribuicao, [] );
        niter = niter + 1;
        console.log( niter, viz.length, otm_verifica_conflitos( atribuicao ) );

        if ( !parar_loop ) {
            // Sem esse timeout o loop nunca devolve
            // o controle à GUI
            setTimeout( loop_tabu, 1 );
        }
        else {
            var dim = document.getElementById( "dim" );
            if ( dim ) {
                dim.remove();
            }
        }

        console.timeEnd( "loop_tabu" )
    }

    function alert_new() {
        var w = document.getElementById( "window" );
        w.style.width = "100vw";
        w.style.height = "100vh";

        var dim = document.createElement( "div" );
        dim.style.backgroundColor = "rgba( 0, 0, 0, 0.5 )";
        dim.style.position = "absolute";
        dim.style.left = "0";
        dim.style.top = "0";
        dim.style.width = "100%";
        dim.style.height = "100%";
        dim.style.minWidth = "100%";
        dim.style.minHeight = "100%";
        dim.style.display = "flex";
        dim.style.justifyContent = "center";
        dim.style.alignItems = "center";
        dim.id = "dim";
        w.appendChild( dim );

        var a = document.createElement( "div" );
        a.style.width = "50%";
        a.style.minWidth = "50%";
        a.style.height = "50%";
        a.style.minHeight = "50%";
        a.style.backgroundColor = "rgb( 255, 255, 255 )";
        a.style.borderRadius = "20px";
        a.style.display = "flex";
        a.style.flexDirection = "column";
        a.style.alignItems = "center";
        a.style.padding = "5px";
        a.style.position = "relative";
        dim.appendChild( a );

        var bp = document.createElement( "button" );
        bp.style.position = "absolute";
        bp.style.bottom = a.style.padding;
        bp.style.fontSize = "1.5em";
        bp.innerHTML = "Parar busca";
        bp.addEventListener( "click", ( e ) => parar_loop = true );
        a.appendChild( bp );
    }
    </script>
</head>

<html id="window">
<body onload="cria_abas();" id="body"></body>
</html>
