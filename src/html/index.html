<!DOCTYPE html>
<meta charset="UTF-8">
<head>
    <title>Distribuidor de Carga Didática</title>
    <style>
        /* Estilos pertinentes à visão de planilha começam com shvw_ */
        .shvw_sheet {
            margin: 0;
            padding: 0;
            border-style: none;
            border-width: 0;
            display: flex;
        }
        .shvw_corner {
            margin: 0;
            padding: 0.1em;
            background-color: white;
            border-color: black;
            border-style: solid;
            border-width: 1px;
            font-size: 1em;
            font-weight: bold;
            width: 10em;
            min-width: 10em;
            height: 1.4em;
            position: fixed;
            left: auto;
            top: auto;
        }
    </style>
    <script>
        function make_c_header( text ) {
            var retval = document.createElement( "div" );
            retval.style.backgroundColor = cor_cabecalho_inativo;
            retval.style.margin = "0";
            retval.style.padding = "0.1em";
            retval.style.borderStyle = "solid";
            retval.style.borderWidth = "1px";
            retval.style.borderRadius = "1px";
            retval.style.fontSize = "1em";
            retval.style.width = ch_width;
            retval.style.minWidth = ch_width;
            retval.style.height = ch_height;
            retval.id = "ch_" + text;
            retval.disciplina = text;

            var cursos = disciplinas[ text ][ "cursos" ]
            cursos = cursos.replace( "Cursos:<br>", "" );
            cursos = cursos.replace( "Curso:<br>", "" );
            cursos = cursos.replaceAll( "<br>", "," );
            cursos = cursos.replaceAll( "&emsp;", " " );

            var dn = document.createElement( "div" );
            dn.style.display = "block";
            dn.style.textOverflow = "ellipsis";
            dn.style.whiteSpace = "nowrap";
            dn.style.maxWidth = ch_width;
            dn.style.minWidth = "100%";
            dn.style.overflow = "hidden";
            dn.style.fontSize = "small";
            // dn.style.fontWeight = "bold";
            dn.innerHTML = cursos;
            retval.appendChild( dn );

            var dc = document.createElement( "div" );
            dc.style.marginTop = "0.2em";
            dc.style.marginBottom = "0.2em";
            dc.style.textAlign  = "left";
            dc.style.marginRight = "1em";
            dc.style.flexGrow = "0";
            dc.style.textOverflow = "ellipsis";
            dc.style.whiteSpace = "nowrap";
            dc.style.overflow = "hidden";
            // dc.style.fontWeight = "bold";

            dc.innerHTML = text.slice( 0, 7 ) + "  <small>" + disciplinas[ text ][ 'nome' ] + "</small>";
            retval.appendChild( dc );

            var dcur = document.createElement( "div" );
            dcur.style.display = "block";
            dcur.style.whiteSpace = "nowrap";
            dcur.style.maxWidth = ch_width;
            dcur.style.overflow = "hidden";
            dcur.style.fontFamily = "monospace";
            // dcur.style.fontWeight = "bold";
            dcur.style.fontSize = "small";
            dcur.innerHTML = disciplinas[ text ][ 'horario' ];
            retval.appendChild( dcur );

            return retval;
        }

        function make_r_header( text ) {
            var retval = document.createElement( "div" );
            retval.style.backgroundColor = cor_cabecalho_inativo;
            retval.style.margin = "0";
            retval.style.padding = "0.1em";
            retval.style.borderStyle = "solid";
            retval.style.borderWidth = "1px";
            retval.style.borderRadius = "1px";
            retval.style.fontSize = "1em";
            retval.style.width = rh_width;
            retval.style.minWidth = rh_width;
            retval.style.height = "1.4em";
            retval.style.textAlign = "left";
            retval.style.alignContent = "center";
            retval.style.overflow = "hidden";
            retval.style.whiteSpace = "nowrap";
            retval.style.textOverflow = "ellipsis";
            retval.innerHTML = text;
            retval.id = "rh_" + text;

            return retval;
        }

        function handle_scroll_rhc( e ) {
            var w = document.getElementById( "window" );

            var rhc = document.getElementById( "shvw_r_header_container" );
            rhc.scroll( { top: w.scrollTop, left: 0, behavior: "instant" } );

            var chc = document.getElementById( "shvw_c_header_container" );
            chc.scroll( { top: 0, left: w.scrollLeft, behavior: "instant" } );
        }

        function atua_celula( e ) {
            var t = e.target;
            const disc = t.disciplina;
            const doc = t.docente;

            if ( atribuicao[ disc ].includes( doc ) ) {
                const idx = atribuicao[ disc ].indexOf( doc );
                atribuicao[ disc ].splice( idx, 1 );
            }
            else {
                atribuicao[ disc ].push( doc );
                atribuicao[ disc ].sort();
            }

            alterna_celula_atribuicao( disc, doc );
        }

        function alterna_celula_atribuicao( disc, doc ) {
            var cell = document.getElementById( "cel_" + disc + "_" + doc );
            if ( !cell ) {
                return;
            }

            var o = document.getElementById( "o_cel_" + disc + "_" + doc );
            if ( o ) {
                o.remove();
            }

            if ( atribuicao[ disc ].includes( doc ) ) {
                var o = document.createElement( "div" );
                o.style.margin = "0";
                o.style.backgroundColor = "red";
                o.style.opacity = "0.5";
                o.style.left = "0";
                o.style.minWidth = "100%";
                o.style.minHeight = "100%";
                cell.appendChild( o );
                o.style.position = "absolute";
                o.style.left = "0";
                o.style.top = "0";
                o.disciplina = cell.disciplina;
                o.docente = cell.docente;
                o.id = "o_" + cell.id;
                o.iscell = true;
            }
        }

        var cor_cabecalho_inativo = "rgb(255, 220, 200)";
        var cor_cabecalho_ativo = "rgb(252, 164, 74)";

        function ilumina_cabecalho( e ) {
            const t = e.target;
            const rt = e.relatedTarget;

            if ( rt && rt.iscell ) {
                document.getElementById( "ch_" + rt.disciplina ).style.backgroundColor = cor_cabecalho_inativo;
                document.getElementById( "rh_" + rt.docente ).style.backgroundColor = cor_cabecalho_inativo;
            }

            document.getElementById( "ch_" + t.disciplina ).style.backgroundColor = cor_cabecalho_ativo;
            document.getElementById( "rh_" + t.docente ).style.backgroundColor = cor_cabecalho_ativo;
        }

        function apaga_cabecalho( e ) {
            const t = e.target;
            const rt = e.relatedTarget;

            if ( rt && rt.iscell ) {
                return;
            }

            document.getElementById( "ch_" + t.disciplina ).style.backgroundColor = cor_cabecalho_inativo;
            document.getElementById( "rh_" + t.docente ).style.backgroundColor = cor_cabecalho_inativo;
        }

        var rh_width = "10em";
        var rh_height = "1.4em";
        var ch_width = "9em";
        var ch_height = "5em";
        function cria_tabela( parent ) {
            const n_columns = Object.keys( disciplinas ).length;
            const n_rows = docentes.length;

            var planilha = document.createElement( "div" );
            planilha.style.overflow = "scroll";
            planilha.style.padding = "0";
            planilha.style.margin = "0";
            planilha.style.borderWidth = "0";
            planilha.style.maxHeight =  "calc( 98vh - 5em )";
            parent.appendChild( planilha );

            var sheet = document.createElement( "div" );
            sheet.id = "shvw_sheet";
            sheet.style.backgroundColor = "white";
            sheet.style.display = "grid";
            sheet.style.width = "fit-content";
            sheet.style.height = "fit-content";
            planilha.appendChild( sheet );

            var cells_container = document.createElement( "div" );
            cells_container.style.padding = "0";
            cells_container.style.margin = "0";
            cells_container.style.borderWidth = "0";
            cells_container.style.gridRow = "2";
            cells_container.style.gridColumn = "2";
            cells_container.style.display = "flex";
            sheet.appendChild( cells_container );

            var mx_p = 0;
            for ( var doc in formularios ) {
                for ( var di in formularios[ doc ] ) {
                    var p = formularios[ doc ][ di ][ 'prioridade' ];
                    if ( mx_p < p ){
                        mx_p = p;
                    }
                }
            }

            var d_list = Object.keys( disciplinas );

            for ( var j = 0; j < n_columns; j++ ) {
                var frhc = document.createElement( "div" );
                cells_container.appendChild( frhc );

                var d = d_list[ j ];

                for ( var i = 0; i < n_rows; ++i ) {

                    var cell = document.createElement( "div" );
                    cell.style.textAlign = "left";
                    cell.style.minHeight = rh_height;
                    cell.style.maxHeight = rh_height;
                    cell.style.minWidth = ch_width;
                    cell.style.borderWidth = "1px";
                    cell.style.borderStyle = "solid";
                    cell.style.padding = "0.1em";
                    cell.style.fontWeight = "bold";
                    cell.style.position = "relative";
                    cell.style.borderColor = "rgb( 200, 200, 200 )";
                    cell.addEventListener( "click", atua_celula );
                    cell.disciplina = d;
                    cell.docente = docentes[ i ];
                    cell.id = "cel_" + d + "_" + docentes[ i ];
                    cell.iscell = true;
                    cell.addEventListener( "mouseover", ilumina_cabecalho );
                    cell.addEventListener( "mouseleave", apaga_cabecalho );
                    frhc.appendChild( cell );

                    if ( formularios[ docentes[ i ] ][ d ] ) {
                        var p = formularios[ docentes[ i ] ][ d ][ 'prioridade' ];
                        cell.innerHTML = p.toString();

                        var r = 80;
                        var g = 180;
                        var b = 170;

                        var alpha = ( mx_p + 1 - p ) / mx_p;
                        r = r * alpha + 255 * ( 1 - alpha );
                        g = g * alpha + 255 * ( 1 - alpha );
                        b = b * alpha + 255 * ( 1 - alpha );

                        cell.style.backgroundColor = "rgb( " + r + ", " + g + ", " + b + " )";
                    }
                    else {
                        cell.style.backgroundColor = "white";
                    }

                    alterna_celula_atribuicao( d, docentes[ i ] );
                }
            }

            var rhc = document.createElement( "div" );
            rhc.id = "shvw_r_header_container";
            rhc.style.gridRow = "2";
            rhc.style.gridColumn = "1";
            rhc.style.height = "inherit";
            rhc.style.overflow = "hidden";
            rhc.style.position = "sticky";
            rhc.style.left = "0";
            rhc.style.width = "max-content";
            rhc.style.backgroundColor = cor_cabecalho_inativo;
            sheet.appendChild( rhc );

            var chc = document.createElement( "div" );
            chc.style.display = "flex";
            chc.id = "shvw_c_header_container";
            chc.style.gridRow = "1";
            chc.style.gridColumn = "2";
            chc.style.width = "inherit";
            chc.style.overflow = "hidden";
            chc.style.position = "sticky";
            chc.style.top = "0";
            sheet.appendChild( chc );

            for ( var i = 0; i < n_rows; i++ ) {
                rhc.appendChild( make_r_header( docentes[ i ] ) );
            }

            for ( var d in disciplinas ) {
                chc.appendChild( make_c_header( d ) );
            }

            var corner = document.createElement( "div" );
            corner.className = "shvw_corner";
            corner.style.minHeight = ch_height;
            corner.style.height = ch_height;
            corner.style.minWidth = rh_width;
            sheet.appendChild( corner );
        }

        var abas = [ "E/S", "Planilha", "Formulários", "Agendas", "Otimização", "Análise" ];
        var aba_ativa = abas[ 0 ];
        var cor_aba_ativa = "rgb(150, 150, 200)";
        var cor_aba_inativa = "rgb(190, 190, 240)";
        
        function cria_abas() {
            var body = document.getElementById( "body" );
            body.style.paddingTop = "1vh";
            body.style.paddingBottom = "1vh";
            body.style.paddingLeft = "1vw";
            body.style.paddingRight = "1vw";
            body.style.border = "none";
            body.style.borderWidth = "0";
            body.style.backgroundColor = "rgb(250, 250, 250)";
            body.style.alignItems = "center";
            body.style.margin = "0";
            body.style.overflow = "hidden";

            var w = document.getElementById( "window" );
            w.style.overflow = "hidden";

            var main_el = document.createElement( "div" );
            main_el.style.maxHeight = "98vh";
            main_el.style.maxWidth = "98vw";
            body.appendChild( main_el );

            var abas_container = document.createElement( "div" );
            abas_container.style.display = "flex";
            main_el.appendChild( abas_container );
            for ( var i in abas ) {
                var aba = document.createElement( "div" );
                if ( abas[ i ] == aba_ativa ){
                    aba.style.backgroundColor = cor_aba_ativa;
                }
                else {
                    aba.style.backgroundColor = cor_aba_inativa;
                }
                aba.style.borderRadius = "5px 5px 0 0";
                aba.style.borderTopStyle = "solid";
                aba.style.borderLeftStyle = "solid";
                aba.style.borderRightStyle = "solid";
                aba.style.borderBottomStyle = "none";
                aba.style.borderWidth = "1px";
                aba.style.padding = "0.5em";
                aba.style.fontSize = "1.25em";
                aba.style.margin = "1px";
                aba.style.marginBottom = "0";
                aba.innerHTML = abas[ i ];
                aba.id = abas[ i ];
                aba.addEventListener( "click", ativa_aba );
                aba.style.userSelect = "none";

                abas_container.appendChild( aba );
            }

            var inter = document.createElement( "div" );
            inter.style.backgroundColor = cor_aba_ativa;
            inter.style.padding = "10px";
            inter.style.border = 'solid';
            inter.style.borderWidth = "1px";
            inter.id = "inter";
            main_el.appendChild( inter );

            atua_aba();
        }

        var disciplinas = {};
        var docentes = [];
        var formularios = {};
        var saldos = {};
        var popularidade = {};
        var atribuicao =  {};
        var trava = {};
        function carrega() {
            var arqinput = document.getElementById( "arqinput" );

            var fr = new FileReader();
            fr.onload = function (){
                var text = fr.result;

                var tmp = JSON.parse( text );
                disciplinas = tmp[ 'disciplinas' ];
                docentes = tmp[ 'docentes' ];
                formularios = tmp[ 'formularios' ];
                saldos = tmp[ 'saldos' ];
                atribuicao = tmp[ 'atribuicao' ];

                // for ( var d in disciplinas ) {
                //     atribuicao[ d ] = [];
                //     trava[ d ] = false;
                // }

                // atualiza_seletores();
                // cria_escolhedores();

                for ( var d in disciplinas ) {
                    var pop = 0.0;
                    for ( var doc in disciplinas[ d ][ 'escolhedores' ] ) {
                        pop += 1.0 / formularios[ disciplinas[ d ][ 'escolhedores' ][ doc ][ 1 ] ][ d ][ 'prioridade' ];
                    }
                    popularidade[ d ] = pop;
                }

                // atualiza_lista_disciplinas();

            };
            fr.readAsText( arqinput.files[ 0 ] );
        }

        function cria_es() {
            var arqinput = document.createElement( "input" );
            arqinput.type = "file";
            arqinput.id = "arqinput";

            var inter = document.getElementById( "inter" );
            inter.appendChild( arqinput );
            
            var b = document.createElement( "button" );
            b.innerHTML = "Carregar arquivo";
            b.addEventListener( "click", carrega );
            inter.appendChild( b );
        }

        function ativa_aba( e ) {
            var t = e.target;
            var a = document.getElementById( aba_ativa );

            a.style.backgroundColor = cor_aba_inativa;
            t.style.backgroundColor = cor_aba_ativa;

            aba_ativa = t.id;

            atua_aba();
        }
    function atua_aba() {
        var inter = document.getElementById( "inter" );
        inter.innerHTML = "";
        switch ( aba_ativa ) {
            case abas[ 0 ]:
                cria_es();
                break;
            case abas[ 1 ]:
                cria_tabela( inter );
                break;
            case abas[ 2 ]:
                break;
            case abas[ 3 ]:
                break;
        }
    }
    </script>
</head>

<html id="window">
<body onload="cria_abas();" id="body"></body>
</html>
